-- function defs
fun fib : Int -> Int =
  go 0 1
  where
    fun go : Int -> Int -> Int -> Int
      | go a b 0 = a
      | go a b n = go b (a + b) (n - 1)
  end

-- let expressions
fun add x y =
  let sum = x + y in sum

-- let fun expressions
fun fib (n : Int) : Int =
  let go a b i =
    if i = 0 then a else go b (a + b) (i - 1)
  in go 0 1 n

-- let match expressions
fun sum (xs : [Int]) : Int =
  let go : [Int] -> Int -> Int
    | go [] acc = acc
    | go (x :: xs) acc = go xs (acc + x)
  in go xs 0

-- match expressions
fun map (f : a -> b) (xs : [a]) : [b] =
  match xs with
  | [] -> []
  | x :: xs -> f x :: map f xs

-- if expressions
fun abs (x : Int) : Int =
  if x < 0 then -x else x

-- record defs
record Person {
  name : String,
  age : Int,
}

-- data defs
data Option a = None | Some a

-- record access
def alice = { name = "Alice", age = 30 }
def aliceName = alice.name

-- record update
def olderAlice = { alice with age = alice.age + 1 }

-- pattern matching with records
fun describePerson (Person { name, age } : Person) : String =
  name ++ " is " ++ Int.toString age ++ " years old"

-- refs
def counter = ref 0

-- mutable update
fun inc (counter : ref Int) : () =
  counter := !counter + 1

-- thunks
data LazyState a 
  = Thunk (() -> a)
  | Forced a

type Lazy a = ref (LazyState a)

-- delaying a computation
fun delay (f : () -> a) : Lazy a =
  ref (Thunk f)

-- forcing a thunk mutates it to a value
fun force (l : Lazy a) : a =
  match !l with
  | Forced v -> v
  | Thunk f -> let v = f () in
      l := Forced v; v

-- self-updating thunks
record Thunk a {
  force : ref (() -> a),
}

fun delay (f : () -> a) : Thunk a =
  Thunk { force = \() -> let res = f () in
          force := \() -> res; res }

def thunkedValue : Lazy Int = delay (expensiveComputation ())

-- streams with thunks
data Stream a where
  (::) : a -> Lazy (Stream a) -> Stream a
end

-- Operators
+ -- addition on a Int, Float, Integer, Rational
- -- subtraction on a Int, Float, Integer, Rational
* -- multiplication on a Int, Float, Integer, Rational
/ -- division on a Int, Float, Integer, Rational
% -- modulo on Int, Integer, Rational
^ -- exponentiation on Int, Integer, Rational

++ -- String concat
. -- function composition
|> -- forward pipe operator
; -- sugar for let-binding with no name
! -- dereference a ref